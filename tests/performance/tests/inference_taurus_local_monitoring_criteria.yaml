---
execution:
- concurrency: 1
  ramp-up: 5s
  hold-for: 20s
  scenario: Inference
scenarios:
  Inference:
    script: register_and_inference.jmx

modules:
  jmeter:
    properties:
      port : 8080
      management_port : 8081
      protocol : http
      input_filepath : kitten.jpg
  server_local_monitoring:
    # metrics_monitoring_taurus and dependencies should be in python path
    class : metrics_monitoring_taurus.Monitor # monitoring class.
  new_passfail:
    class: new_passfail.PassFailStatus



services:
  - module: server_local_monitoring # should be added in modules section
    ServerLocalClient: # keyword from metrics_monitoring_taurus.Monitor
    - interval: 1s
      metrics:
        - cpu
        - disk-space
        - mem
        - sum_memory_percent

reporting:
- module: passfail
  criteria:
    - fail of s2_fail >50%, stop as failed
    - p90 of s2_p90 >250ms  , stop as failed
    - avg-rt of s2_avg_rt >1s , stop as failed
    - class: bzt.modules.monitoring.MonitoringCriteria
      subject: ServerLocalClient/sum_memory_percent
      condition: '>'
      threshold: 4
      timeframe: 1s
      stop : true
      fail : true

- module: junit-xml
  data-source: pass-fail
- module: junit-xml
  data-source: sample-labels
- module: final-stats
  dump-csv : ${BASEDIR}/final_stats.csv

settings:
  env:
    BASEDIR : '.'